{% extends 'layout.html.twig' %}

{% block content %}
    <div class="run-block">
        {% if users|length >= 2 %}
            <form method="post" id="run_form">
                <div class="user-field">
                    <h2>Select the participants of your Secret Santa</h2>
                    {% if errors and errors.users %}
                        <span class="error">{{ errors.users|join('<br />') }}</span>
                    {% endif %}
                    {% spaceless %}
                        <div class="user-list">
                            {% for user in users if not user.isBot and not user.deleted %}
                                <label class="user-item" for="user-{{ user.id }}">
                                    <input type="checkbox"
                                           {{ user.name in selectedUsers ? 'checked="checked"' : '' }}
                                           name="users[]"
                                           value="{{ user.name }}"
                                           id="user-{{ user.id }}">
                                    <img src="{{ user.profile.image32 }}" alt="{{ user.profile.realName }}" />
                                    <span>{{ user.profile.realName }} ({{ user.name }})</span>
                                </label>
                            {% endfor %}
                        </div>
                    {% endspaceless %}
                </div>

                <div class="message-field">
                    <h2>
                        <label class="control-label" for="message">Write an optionnal message</label>
                    </h2>

                    <textarea name="message" id="message" rows="3">{{ message }}</textarea>
                    <p class="help">Anything you want, but this is the right place to give a deadline and a price limit!</p>
                </div>

                <div class="next">
                    <h2>What happens next?</h2>
                    <div>
                        <p>
                            We are going to shuffle selected users and send them a private message in Slack, looking like this:
                        </p>

                        <div class="is-center">
                            <img class="pure-img-responsive" alt="Sample message received by users" src="/images/sample.png">
                        </div>

                        <p>
                            Anything else is up to you, have fun!
                        </p>
                    </div>
                </div>

                <div class="is-center">
                    <button type="submit" class="big-button" id="run_btn">
                        <span class="fa fa-paper-plane" aria-hidden="true"></span>
                        Finish and send Secret Santa messages!
                    </button>
                </div>

            </form>

            <script type="text/javascript">
                /**
                 * I did know this is a global and I feel bad.
                 * Next time I will install 10mb of npm and react javascript to switch a flag :)
                 *
                 * @type {boolean}
                 */
                var secretSantaFormSubmitted = false;

                /**
                 * Prevent the multi-submit of the form
                 */
                document.getElementById('run_form').addEventListener("submit", function(e) {
                    if (secretSantaFormSubmitted) {
                        e.preventDefault();
                    } else {
                        secretSantaFormSubmitted = true;
                        document.getElementById('run_btn').disabled = true;
                        document.getElementById('run_btn').children[0].className = 'fa fa-hourglass-start';
                    }
                }, false);
            </script>
        {% else %}
            <div class="error" role="alert">
                Ooops, we didn't find enough users in your Slack team. You need at least 2 users to start a Secret Santa.
            </div>
        {% endif %}
    </div>
{% endblock content %}
